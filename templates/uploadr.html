<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Mixtur</title>
  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5-els.js"></script>
  <![endif]-->
  
  <style>
  
  h1, h2, h3, h4, h5, h6 { font-weight: normal; }
  html { height: 100%; }
  
  body {
    margin: 0;
    padding: 0;
    font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Open Sans", sans-serif;
    font-size: 13px;
    font-weight: 300;
    

    display: flex;
    min-height: 100%;
    flex-direction: column;
  }
  
  /* The MIT License */
  .dropzone,
  .dropzone *,
  .dropzone-previews,
  .dropzone-previews * {
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
  }
  .dropzone {
    position: relative;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(0,0,0,0.02);
    padding: 10px;
  }
  .dropzone.dz-clickable {
    cursor: pointer;
  }
  .dropzone.dz-clickable .dz-message,
  .dropzone.dz-clickable .dz-message span {
    cursor: pointer;
  }
  .dropzone.dz-clickable * {
    cursor: default;
  }
  .dropzone .dz-message {
    opacity: 1;
    -ms-filter: none;
    filter: none;
  }
  .dropzone.dz-drag-hover {
    border-color: rgba(0,0,0,0.15);
    background: rgba(0,0,0,0.04);
  }
  .dropzone.dz-started .dz-message {
    display: none;
  }
  .dropzone .dz-preview,
  .dropzone-previews .dz-preview {
    background: rgba(255,255,255,0.8);
    position: relative;
/*    display: inline-block;*/
    vertical-align: top;
    border: 1px solid #acacac;
    padding: 6px 6px 6px 6px;
  }
  .dropzone .dz-preview.over {
    border: 2px dashed #000 !important;
  }
  #songs-dropzone .dz-preview {
    background: rgba(255,255,255,0.8);
    position: relative;
/*    display: block;*/
    margin: 0 0 10px 0;
    vertical-align: top;
    border: 1px solid #acacac;
    padding: 6px 6px 6px 6px;
  }
  .dropzone .dz-preview.dz-file-preview [data-dz-thumbnail],
  .dropzone-previews .dz-preview.dz-file-preview [data-dz-thumbnail] {
/*    display: none;*/
  }
  .dropzone .dz-preview .dz-details,
  .dropzone-previews .dz-preview .dz-details {
    position: relative;
  }
  #cover-dropzone .dz-details {
    position: relative;
    margin: 0;
  }
  .dropzone .dz-preview .dz-details .dz-filename,
  .dropzone-previews .dz-preview .dz-details .dz-filename {
    overflow: hidden;
    height: 100%;
  }
  .dropzone .dz-preview .dz-details img,
  .dropzone-previews .dz-preview .dz-details img {
/*    position: absolute;*/
/*    top: 0;
    left: 0;
    width: 100px;
    height: 100px;*/
    max-width: 100%;
  }
  .dropzone .dz-preview .dz-details .dz-size,
  .dropzone-previews .dz-preview .dz-details .dz-size {
/*    position: absolute;
    bottom: -28px;
    left: 3px;
    height: 28px;
    line-height: 28px;*/
  }
  .dropzone .dz-preview.dz-error .dz-error-mark,
  .dropzone-previews .dz-preview.dz-error .dz-error-mark {
    display: block;
  }
  .dropzone .dz-preview.dz-success .dz-success-mark,
  .dropzone-previews .dz-preview.dz-success .dz-success-mark {
    display: block;
  }
  .dropzone .dz-preview:hover .dz-details img,
  .dropzone-previews .dz-preview:hover .dz-details img {
/*    display: none;*/
  }
  .dropzone .dz-preview .dz-success-mark,
  .dropzone-previews .dz-preview .dz-success-mark,
  .dropzone .dz-preview .dz-error-mark,
  .dropzone-previews .dz-preview .dz-error-mark {
    display: none;
    position: absolute;
    width: 40px;
    height: 40px;
    font-size: 30px;
    text-align: center;
    right: -10px;
    top: -10px;
  }
  .dropzone .dz-preview .dz-success-mark,
  .dropzone-previews .dz-preview .dz-success-mark {
    color: #8cc657;
  }
  .dropzone .dz-preview .dz-error-mark,
  .dropzone-previews .dz-preview .dz-error-mark {
    color: #ee162d;
  }
  .dropzone .dz-preview .dz-progress,
  .dropzone-previews .dz-preview .dz-progress {
    position: absolute;
    top: 100px;
    left: 6px;
    right: 6px;
    height: 6px;
    background: #d7d7d7;
    display: none;
  }
  .dropzone .dz-preview .dz-progress .dz-upload,
  .dropzone-previews .dz-preview .dz-progress .dz-upload {
    display: block;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 0%;
    background-color: #8cc657;
  }
  .dropzone .dz-preview.dz-processing .dz-progress,
  .dropzone-previews .dz-preview.dz-processing .dz-progress {
    display: block;
  }
  .dropzone .dz-preview .dz-error-message,
  .dropzone-previews .dz-preview .dz-error-message {
    display: none;
    position: absolute;
    top: -5px;
    left: -20px;
    background: rgba(245,245,245,0.8);
    padding: 8px 10px;
    color: #800;
    min-width: 140px;
    max-width: 500px;
/*    z-index: 500;*/
  }
  .dropzone .dz-preview:hover.dz-error .dz-error-message,
  .dropzone-previews .dz-preview:hover.dz-error .dz-error-message {
    display: block;
  }
  
  html, body, .drop_container {
      min-height: 100% !important;
/*      height: 90%;*/
  }
  
  .drop_container {
    display: flex;
/*    flex-direction: row;*/
  }
  .drop_container .dropzone {
/*    display: flex;
    flex: 1 0 0;*/
    background-color: DeepSkyBlue;
    margin: 5px;
    flex: 3;
  }
  .drop_container .dropzone#cover-dropzone {
    height: 25%;
    flex: 1;
  }
  #mix-title {
    background-color: SkyBlue;
    border: none;
    height: 50px;
    display: block;
    margin: 5px;
/*    width: 100%;*/
    font-family: sans-serif;
    font-size: 48px;
    appearance: none;
    box-shadow: none;
    border-radius: none;
  }
  
  .delete {
    color: #ee162d;
    cursor: pointer;
    position: absolute;
    width: 40px;
    height: 40px;
    font-size: 30px;
    text-align: center;
    right: -10px;
    top: -10px;
  }
  label {
/*    font-weight: bold;*/
    font-size: 20px;
/*    display: block;*/
/*    width: 50px;*/
/*    float: left;*/
  }
  .dz-details p {
    margin: 0 0 5px 0;
  }
  p.song-title input {
    margin: 0em;
    border: none;
    display: inline-block;
    text-align: start;
    font-size: 20px;
  }
/*  .dz-details {
    display: flex;
  }*/
  .dz-details > p {
    display: flex;
  }
  .dz-details > p input {
    margin: 0em;
    border: none;
    display: inline-block;
    padding: 5px;
    text-align: start;
    font-size: 20px;
  }
  .dz-details > p label,
  .dz-details > p span.file {
    flex: 1;
  }
  .dz-details > p input,
  .dz-details > p span.file-info {
    flex: 9;
  }
  
  .dz-preview{
    display: flex;
  }
  .dz-preview > div.dz-num{
    flex: 1%;
    font-size: 20px;
    font-weight: bold;
  }
  .dz-preview > div.dz-details{
    flex: 96%;
  }
  
  #drop_here {
    display:none;
    /*set the div in the top-left corner of the screen*/
    position: fixed;
    top:0;
    left:0;
    background-color: rgba(0, 0, 0, 0.4);
    /*set the width and height to 100% of the screen*/
    width:100%;
    height:100%;
    color: white;
    z-index: 9999;
    
    justify-content: center;
    align-items: center;
  }
  
  </style>
</head>

<body>
  <div id="drop_here">
    <span>Drop items here!</span>
  </div>
  <input id="mix-title" name="mix-title" type="text" value="Untitled Mix"></input>
  <input id="mix-id" name="mix-id" type="hidden"></input>
  <div class="drop_container">
    <form action="/uploadr/song/" class="dropzone" id="songs-dropzone"></form>
    <!-- <form action="/uploadr/song/" class="dropzone dz-started" id="songs-dropzone"><div class="dz-default dz-message"><span>Drop songs here to upload...</span></div><div class="dz-preview dz-file-preview" draggable="true">   <div class="dz-num">1.</div>   <div class="dz-details">     <p class="song-title">       <label for="song-title">Title</label>       <input type="text" name="song-title" id="song-title" value="Wolf Like Me">     </p>     <p class="song-artist">       <label for="song-title">Artist</label>       <input type="text" name="song-title" id="song-title" value="Anna Calvi">     </p>     <p class="song-file"><span class="file">&nbsp;</span><span class="file-info" data-dz-name="">song_anna_calvi_wolf_like_me copy.mp3</span><span class="dz-size" data-dz-size=""><strong>5.2</strong> MiB</span></p>     <img data-dz-thumbnail="">   </div>   <div class="dz-success-mark"><span>✔</span></div>   <div class="delete" data-dz-remove=""><span>✘</span></div> </div><div class="dz-preview dz-file-preview" draggable="true">   <div class="dz-num">1.</div>   <div class="dz-details">     <p class="song-title">       <label for="song-title">Title</label>       <input type="text" name="song-title" id="song-title" value="Je Suis Orphelin">     </p>     <p class="song-artist">       <label for="song-title">Artist</label>       <input type="text" name="song-title" id="song-title" value="The Balfa Brothers">     </p>     <p class="song-file"><span class="file">&nbsp;</span><span class="file-info" data-dz-name="">song_balfa_brothers_je_suis_orphelin_(the_orphan_waltz).mp3</span><span class="dz-size" data-dz-size=""><strong>6.1</strong> MiB</span></p>     <img data-dz-thumbnail="">   </div>   <div class="dz-success-mark"><span>✔</span></div>   <div class="delete" data-dz-remove=""><span>✘</span></div> </div></form> -->
    <form action="/uploadr/cover/" class="dropzone" id="cover-dropzone"></form>
  </div>
  <a href="#" id="upload">Upload</a>
  
  <script src="/static/js/d3.js" charset="utf-8"></script>
  <script src="/static/js/dropzone.min.js"></script>
  <script src="/static/js/id3.min.js" type="text/javascript"></script>
  <script>
  
  var x = '<div class="dz-preview dz-file-preview" draggable="true"> \
  <div class="dz-num">1.</div> \
  <div class="dz-details"> \
    <p class="song-title"> \
      <label for="song-title">Title</label> \
      <input type="text" name="song-title"></input> \
    </p> \
    <p class="song-artist"> \
      <label for="song-artist">Artist</label> \
      <input type="text" name="song-artist"></input> \
    </p> \
    <p class="song-file"><span class="file">&nbsp;</span><span class="file-info" data-dz-name></span><span class="dz-size" data-dz-size></span></p> \
    <img data-dz-thumbnail /> \
  </div> \
  <div class="dz-success-mark"><span>✔</span></div> \
  <div class="delete" data-dz-remove><span>✘</span></div> \
</div>'
  var is_file = true;
  var leave_called = false;
  var overlay_timer = null;
  Dropzone.autoDiscover = false;
  var songs_drop = new Dropzone(document.body, {
      method: "POST", // can be changed to "put" if necessary
      maxFilesize: 20, // in MB
      dictDefaultMessage: "Drop songs here to upload...",
      parallelUploads: 20,
      // createImageThumbnails: false,
      previewTemplate: x,
      // paramName: "song", // The name that will be used to transfer the file
      paramName: "file",
      uploadMultiple: true, // This option will also trigger additional events (like processingmultiple).
      headers: {
        "My-Awesome-Header": "header value"
      },
      addRemoveLinks: false,
      previewsContainer: ".drop_container .dropzone",
      url: "/uploadr/song/",
      clickable: false,
      // createImageThumbnails: true,
      // maxThumbnailFilesize: 2, // in MB
      thumbnailWidth: 300,
      thumbnailHeight: 300,
      maxFiles: 30,
      acceptedFiles: ".mp3, .png, .jpg",
      autoProcessQueue: false, // When set to false you have to call myDropzone.processQueue() yourself in order to upload the dropped files.
      // forceFallback: false,
      
      dragstart: function() {
        // console.log('start drag!')
      },
      dragover: function() {
      },
      dragenter: function() {
        // console.log('enter!')
        d3.select("#drop_here").style("display", function(){ return is_file ? "flex" : "none"})
        // console.log(this)
        // console.log(a, b, c)
      },
      dragend: function() {
        // console.log('end')
      },
      dragleave: function() {
        // d3.select("#drop_here").style("display", "none")
      },
      init: function() {
        // console.log("init");
        // this.on("dragend", function(event) {
        //     alert("dragend")
        // });
      },
      canceled: function(){
        console.log('canceled!!!')
      },
      accept: function(file, done) {
        if(file.type.indexOf('image') > -1){
          d3.select(file.previewElement).remove();
          d3.select("#drop_here").style("display", "none")
          d3.select("#cover-dropzone").node().innerHTML = '<div class="dz-preview dz-file-preview"><div class="dz-details"><img src="" data-dz-thumbnail /></div></div>'
          // console.log(file)
          // return;
        }
        file.previewElement.addEventListener('dragstart', handleDragStart, false);
        file.previewElement.addEventListener('dragenter', handleDragEnter, false)
        file.previewElement.addEventListener('dragover', handleDragOver, false);
        file.previewElement.addEventListener('dragleave', handleDragLeave, false);
        file.previewElement.addEventListener('drop', handleDrop, false);
        file.previewElement.addEventListener('dragend', handleDragEnd, false);
        d3.select("#drop_here").style("display", "none")
        // console.log("accept", file, done);
        done();
      },
      thumbnail: function(a, b) {
        d3.select("#cover-dropzone img").attr("src", b)
        // console.log(b)
      },
      fallback: function() {
        // console.log("fallback");
      },
      success: function(file, resp) {
        console.log('success', resp)
      },
      // sending: function(file, xhr, formData) {
      //   console.log(xhr, formData)
      //   // console.log(formData)
      //   formData.append("mix_id", d3.select("input[name='mix-id']").node().value);
      //   formData.append("mix_title", d3.select("input[name='mix-title']").node().value);
      //   formData.append("THIS_artist", d3.select(file.previewElement).select("p.song-artist input").attr("value"));
      //   formData.append("filesize", file.size);
      // }
      sendingmultiple: function(files, xhr, formData) {
        console.log(files, xhr, formData)
        // console.log(formData)
        formData.append("mix_id", d3.select("input[name='mix-id']").node().value);
        formData.append("mix_title", d3.select("input[name='mix-title']").node().value);
        files.forEach(function(f){
          formData.append("song_filesize", f.size);
          formData.append("song_artist", d3.select(f.previewElement).select("p.song-artist input").node().value);
          formData.append("song_title", d3.select(f.previewElement).select("p.song-title input").node().value);
          formData.append("song_num", d3.select(f.previewElement).select(".dz-num").text());
        })
      }
      // processing: function() {
      //   this.options.autoProcessQueue = true;
      // }
    });

    var cover_drop = new Dropzone("#cover-dropzone", {
        method: "POST", // can be changed to "put" if necessary
        maxFilesize: 10, // in MB
        dictDefaultMessage: "Drop album cover here to upload...",
        paramName: "cover", // The name that will be used to transfer the file
        previewTemplate: '<div class="dz-preview dz-file-preview"><div class="dz-details"><img data-dz-thumbnail /></div></div>',
        thumbnailWidth: null,
        thumbnailHeight: null
      });
  
  
  
    d3.select("#upload").on("click", function(){
      // console.log(songs_drop)
      songs_drop.processQueue(); //processes the queue
      d3.event.preventDefault();
    });
  
  
  
  
  
  
  // Dropzone.autoDiscover = false;
  //
  // var songs_drop = new Dropzone("#songs-dropzone");
  // songs_drop.options.paramName = "song"
  // songs_drop.options.maxFilesize = 10
  // var cover_drop = new Dropzone("#cover-dropzone");
  // cover_drop.options.paramName = "cover"

  //  = Dropzone.options.songsDropzone = {
  //   paramName: "songs", // The name that will be used to transfer the file
  //   maxFilesize: 10, // MB
  //   accept: function(file, done) {
  //     if (file.name == "justinbieber.jpg") {
  //       done("Naha, you don't.");
  //     }
  //     else { done(); }
  //   }
  // };
  
  songs_drop.on("addedfile", function(file) {

    // var tags = ID3.getAllTags(file.name);
    // console.log(tags, file)

    ID3.loadTags(file.name, function() {
      var tags = ID3.getAllTags(file.name);
      d3.select(file.previewElement).select("p.song-title input").attr("value", tags.title)
      d3.select(file.previewElement).select("p.song-artist input").attr("value", tags.artist)
      console.log(tags)
      // console.log(tags.artist + " - " + tags.title + ", " + tags.album);
    }, {
        dataReader: FileAPIReader(file)
    });
    
    var nums = [].slice.call(document.querySelectorAll(".dz-num"));
    nums.forEach(function(n, i){
      d3.select(n).text(i+1)
    })

  });
  songs_drop.on("maxfilesreached", function(file) { console.log("maxfilesreached"); });
  songs_drop.on("maxfilesexceeded", function(file) { console.log("maxfilesexceeded"); });
  
  
  var dragSrcEl = null;
  function handleDragStart(e) {
    is_file = false;
    // Target (this) element is the source node.
    // this.style.opacity = '0.4';

    dragSrcEl = this;

    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
  }
  function handleDragOver(e) {
    if (e.preventDefault) {
      e.preventDefault(); // Necessary. Allows us to drop.
    }

    e.dataTransfer.dropEffect = 'move';  // See the section on the DataTransfer object.

    return false;
  }
  function handleDragEnter(e) {
    // this / e.target is the current hover target.
    this.classList.add('over');
  }
  function handleDragLeave(e) {
    this.classList.remove('over');  // this / e.target is previous target element.
  }
  function handleDrop(e) {
    // this/e.target is current target element.

    if (e.stopPropagation) {
      e.stopPropagation(); // Stops some browsers from redirecting.
    }

    // Don't do anything if dropping the same column we're dragging.
    if (dragSrcEl != this) {
      // Set the source column's HTML to the HTML of the column we dropped on.
      dragSrcEl.innerHTML = this.innerHTML;
      this.innerHTML = e.dataTransfer.getData('text/html');
      
      var nums = [].slice.call(document.querySelectorAll(".dz-num"));
      nums.forEach(function(n, i){
        d3.select(n).text(i+1)
      })
    }

    return false;
  }
  function handleDragEnd(e) {
    // this/e.target is the source node.
    var cols = document.querySelectorAll('.dz-preview');
    [].forEach.call(cols, function (col) {
      col.classList.remove('over');
    });
    is_file = true;
  }
  // drag n drop
  
  // [].forEach.call(cols, function(col) {
  //   col.addEventListener('dragstart', handleDragStart, false);
  //   col.addEventListener('dragenter', handleDragEnter, false)
  //   col.addEventListener('dragover', handleDragOver, false);
  //   col.addEventListener('dragleave', handleDragLeave, false);
  //   col.addEventListener('drop', handleDrop, false);
  //   col.addEventListener('dragend', handleDragEnd, false);
  // });
  
  var delay = (function(){
    var timer = 0;
    return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
   };
  })();
  d3.select("#mix-title").on("keyup", function(){
    var mix_title = this.value;
    delay(function(){
      var mix_id = d3.select("#mix-id").node().value;
      
      // d3.json("/uploadr/test/")
      //     .header("Content-type", "application/x-www-form-urlencoded")
      //     .post("mix_title="+mix_title+"&mix_id="+mix_id, function(error, resp) {
      //       if(error){ console.log(error); }
      //       if(resp){
      //         if(resp.mix_id){
      //           d3.select("#mix-id").attr("value", resp.mix_id);
      //           console.log(resp.mix_id)
      //         }
      //       }
      //     });


      // d3.xhr("/uploadr/test/")
      //   .post(
      //     JSON.stringify({year: "2012", customer: "type1"}),
      //     function(err, rawData){
      //         var data = JSON.parse(rawData);
      //         console.log("got response", data);
      //     }
      //   );
      // function(error, data) {
      //        console.log(error, data)
      //     })
      //    .header("Content-Type","application/json")
      //    .send("POST", JSON.stringify({"mix_title": mix_title, "mix_id": mix_id}));
      
    }, 1000 );
  })
  </script>
</body>

</html>
